// frontend/src/pages/ProfilePage.jsx\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuth } from '../hooks/useAuth';\nimport '../styles/ProfilePage.css';
import LoyaltyCard from '../components/LoyaltyCard';
import { motion } from 'framer-motion';\n\nconst ProfilePage = () => {\n    const { user, isAuthenticated, logout } = useAuth();
    const [loyaltyHistory, setLoyaltyHistory] = useState([]);
    const [bookingTotalCount, setBookingTotalCount] = useState(0); // لإظهار العدد الإجمالي للحجوزات\n    const navigate = useNavigate();\n    const [bookings, setBookings] = useState([]);\n    const [loyaltyPoints, setLoyaltyPoints] = useState(null); // null للإشارة إلى عدم التحميل بعد\n    const [isLoading, setIsLoading] = useState(true);\n    const [error, setError] = useState('');\n\n    useEffect(() => {\n        if (!isAuthenticated) {\n            navigate('/login');\n            return;\n        }\n\n        fetchProfileData();\n    }, [isAuthenticated, navigate]);\n\n    // تم دمج fetchUserData و fetchLoyaltyData في دالة واحدة جديدة: fetchProfileData
       // تم حذف الدالة fetchUserData ودمجها في fetchProfileData\n        setIsLoading(true);\n        setError('');\n\n        try {\n            const token = localStorage.getItem('token');\n            const headers = {\n                'Authorization': `Bearer ${token}`,\n                'Content-Type': 'application/json'\n            };\n\n            // جلب الحجوزات\n            const bookingsResponse = await fetch('/api/v1/bookings/me', { headers });\n            if (bookingsResponse.ok) {\n                const bookingsData = await bookingsResponse.json();\n                setBookings(bookingsData.data || []);\n            }\n\n            // في المستقبل، سيتم جلب نقاط الولاء من API منفصل\n            // تم حذف القيمة المؤقتة، سيتم جلبها من API الآن\n        } catch (err) {\n            setError('فشل تحميل البيانات');\n            console.error(err);\n        } finally {\n            // لا نغير حالة التحميل هنا، بل في الدالة الجديدة
        }\n    }, [isAuthenticated, navigate]);

    // تم حذف الدالة fetchUserData ودمجها في fetchProfileData> {
        setIsLoading(true);
        setError('');
        try {
            const token = localStorage.getItem('accessToken'); // استخدام accessToken بعد التعديل
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            // جلب جميع البيانات في طلب واحد
            const response = await fetch('/api/v1/profile/data', { headers });
            const data = await response.json();

            if (!response.ok || !data.success) {
                // تحسين معالجة الأخطاء: إذا كان الخطأ 401، فهذا يعني انتهاء صلاحية الجلسة
                if (response.status === 401) {
                    setError('انتهت صلاحية الجلسة. يرجى تسجيل الدخول مرة أخرى.');
                    logout(); // تسجيل الخروج التلقائي
                    navigate('/login');
                    return;
                }
                throw new Error(data.error || 'فشل جلب بيانات الملف الشخصي.');
            }

            // تحديث حالة الحجوزات
            setBookings(data.data.bookings.data || []);
            setBookingTotalCount(data.data.bookings.totalCount || 0);

            // تحديث حالة نقاط الولاء
            setLoyaltyPoints(data.data.loyalty.totalPoints || 0);
            setLoyaltyHistory(data.data.loyalty.history || []);

        } catch (err) {
            setError('فشل تحميل البيانات: ' + err.message);
            console.error(err);
        } finally {
            setIsLoading(false);
        }
    }, [isAuthenticated, navigate, logout]);

    const handleLogout = async () => {\n        await logout();\n        navigate('/login');\n    };\n\n    if (isLoading || loyaltyPoints === null) {\n        return (\n            <div className=\"profile-container\">\n                <div className=\"profile-card\">\n                    <p>جاري التحميل...</p>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ duration: 0.5 }}\n            className=\"profile-container\"\n        >\n            <motion.div\n                initial={{ opacity: 0, y: -20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ duration: 0.5 }}\n                className=\"profile-header\"\n            >\n                <div className=\"profile-info\">\n                    <h1>ملفي الشخصي</h1>\n                    <p className=\"user-email\">{user?.email}</p>\n                </div>\n                <motion.button\n                    whileHover={{ scale: 1.05 }}\n                    whileTap={{ scale: 0.95 }}\n                    className=\"btn-logout\"\n                    onClick={handleLogout}\n                >\n                    تسجيل الخروج\n                </motion.button>\n            </motion.div>\n\n            {error && <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className=\"error-message\">{error}</motion.div>}\n\n            <motion.div\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.2, duration: 0.5 }}\n                className=\"profile-grid\"\n            >\n                {/* بطاقة نقاط الولاء الاحترافية */}\n                <LoyaltyCard totalPoints={loyaltyPoints} username={user?.username || user?.email.split('@')[0]} />\n\n                {/* بطاقة الحجوزات */}\n                <motion.div\n                    whileHover={{ scale: 1.02 }}\n                    className=\"profile-card bookings-card\"\n                >\n                    <h2>حجوزاتي</h2>\n                    <div className=\"bookings-count\">\n                        <span className=\"count-number\">{bookingTotalCount}</span>\n                        <span className=\"count-label\">حجز</span>\n                    </div>\n                    <p className=\"bookings-description\">إجمالي عدد الحجوزات: {bookingTotalCount}</p>\n                </motion.div>\n            </motion.div>\n\n            {/* قائمة الحجوزات */}\n            <motion.div\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.4, duration: 0.5 }}\n                className=\"bookings-section\"\n            >\n                <h2>سجل الحجوزات</h2>\n                {bookings.length === 0 ? (\n                    <div className=\"no-bookings\">\n                        <p>لا توجد حجوزات حالياً</p>\n                        <button className=\"btn-primary\" onClick={() => navigate('/booking')}>\n                            احجز الآن\n                        </button>\n                    </div>\n                ) : (\n                    <div className=\"bookings-list\">\n                        {bookings.map((booking) => (\n                            <motion.div\n                                key={booking.id}\n                                initial={{ opacity: 0, x: -20 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                transition={{ duration: 0.3 }}\n                                whileHover={{ x: 5, boxShadow: \"0 4px 8px rgba(0, 0, 0, 0.1)\" }}\n                                className=\"booking-item\"\n                            >\n                                <div className=\"booking-details\">\n                                    <p className=\"booking-date\">\n                                        <strong>التاريخ:</strong> {new Date(booking.booking_date).toLocaleDateString('ar-LY')}\n                                    </p>\n                                    <p className=\"booking-duration\">\n                                        <strong>المدة:</strong> {booking.duration_hours} ساعات\n                                    </p>\n                                    <p className=\"booking-price\">\n                                        <strong>السعر:</strong> {booking.total_price} دينار\n                                    </p>\n                                </div>\n                                <div className=\"booking-status\">\n                                    <span className={`status-badge status-${booking.status}`}>\n                                        {booking.status === 'pending' && 'في الانتظار'}\n                                        {booking.status === 'confirmed' && 'مؤكد'}\n                                        {booking.status === 'cancelled' && 'ملغى'}\n                                        {booking.status === 'completed' && 'مكتمل'}\n                                    </span>\n                                </div>\n                            </motion.div>\n                        ))}\n                    </div>\n                )}\n            </motion.div>\n\n            {/* سجل نقاط الولاء الجديد */}\n            <motion.div\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.6, duration: 0.5 }}\n                className=\"loyalty-history-section\"\n            >\n                <h2>سجل نقاط الولاء</h2>\n                <div className=\"loyalty-history-table\">\n                    <table>\n                        <thead>\n                            <tr>\n                                <th>التاريخ</th>\n                                <th>السبب</th>\n                                <th>التغيير</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            {loyaltyHistory.length > 0 ? (\n                                loyaltyHistory.map((item) => (\n                                    <motion.tr\n                                        key={item.id}\n                                        initial={{ opacity: 0, y: 10 }}\n                                        animate={{ opacity: 1, y: 0 }}\n                                        transition={{ duration: 0.2 }}\n                                        className={item.points_change > 0 ? 'positive' : 'negative'}\n                                    >\n                                        <td>{new Date(item.created_at).toLocaleDateString('ar-LY')}</td>\n                                        <td>{item.reason}</td>\n                                        <td>{item.points_change > 0 ? `+${item.points_change}` : item.points_change}</td>\n                                    </motion.tr>\n                                ))\n                            ) : (\n                                <tr>\n                                    <td colSpan=\"3\" style={{ textAlign: 'center' }}>لا يوجد سجل نقاط حتى الآن.</td>\n                                </tr>\n                            )}\n                        </tbody>\n                    </table>\n                </div>\n            </motion.div>\n\n            {/* زر الحجز الجديد */}\n            <div className=\"profile-actions\">\n                <motion.button\n                    whileHover={{ scale: 1.05 }}\n                    whileTap={{ scale: 0.95 }}\n                    className=\"btn-primary\"\n                    onClick={() => navigate('/booking')}\n                >\n                    حجز جديد\n                </motion.button>\n            </div>\n        </motion.div>\n    );\n};\n\nexport default ProfilePage;\n
